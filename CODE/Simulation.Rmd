---
title: "Simulation"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  pdf_document: 
    toc: yes
    fig_caption: yes
    fig_crop: no
    number_sections: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Poisson Events

## Libraries
```{r}
library(survival)
library(FRESA.CAD)
#source("~/GitHub/FRESA.CAD/R/RRPlot.R")
#source("~/GitHub/FRESA.CAD/R/PoissonEventRiskCalibration.R")
op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
#pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)
layout(matrix(1:1, nrow=1))

```
## Parameters and risk
```{r}
censoredProb <- 0.000
timeSpan <- 10
timeInterval = 0.01
InitialPopulatoin <- 1000
ContBetaRate_1 <- 0.00005
BinBetaRate_1 <- 0.0005
BinBetaRate_2 <- 0.0002
BaselineHazard <- 0.00001
BinPrevalence1 <- 0.10
BinPrevalence2 <- 0.10

RContBetaRate_1 <- ContBetaRate_1
RBinBetaRate_1 <- BinBetaRate_1
RBinBetaRate_2 <- BinBetaRate_2
RBaselineHazard <- BaselineHazard



```

### Simulate

```{r}
#source("C:/Users/jtame/Documents/GitHub/RISKPLOTS/PlotRiskCategoriesAndTimetoEvent.R")

source("~/GitHub/RISKPLOTS/simulate_events.R")

```


## RRplots Low Prevalence

```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}

plotTimeInterval <- timeSpan*3 #Not calibrated.

hazard <- -log(1.0-simulatedDataFrame$pevent)
hboost <- plotTimeInterval/timeInterval
pvalue <- 1.0-exp(-hboost*hazard)


rdata <- cbind(simulatedDataFrame$status,pvalue)
summary(rdata[,2])
table(simulatedDataFrame$status)

par(cex=0.75)
RRAnalysisCI <- RRPlot(rdata,atRate=c(0.90),
                     timetoEvent=simulatedDataFrame$time,
                     title="Simulation",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=plotTimeInterval)

RRAnalysisCI_LP <- RRAnalysisCI

par(op)

```


### By Risk Categories and Mean Time to Event
```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}

source("~/GitHub/RISKPLOTS/PlotRiskCategoriesAndTimetoEvent.R")
pander::pander(obsexp)
pander::pander(timesdata)

```


### Risk Calibration

```{r results = "asis", warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}
op <- par(no.readonly = TRUE)


crdata <- cbind(simulatedDataFrame$status,pvalue,simulatedDataFrame$time)

#calprob <- CalibrationProbPoissonRisk(crdata,timeInterval=plotTimeInterval)
calprob <- CalibrationProbPoissonRisk(crdata)


pander::pander(c(h0=calprob$h0,
                 Gain=calprob$hazardGain,
                 DeltaTime=calprob$timeInterval),
               caption="Cox Calibration Parameters")

```

### After Calibration
```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}

h0 <- calprob$h0

caldata <- cbind(simulatedDataFrame$status,calprob$prob)

par(cex=0.75)

rrAnalysisTrain <- RRPlot(caldata,atRate=c(0.90),
                     timetoEvent=simulatedDataFrame$time,
                     title="Cal. Simulation",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=calprob$timeInterval)

```


### By Risk Categories and Mean Time to Event after calibration
```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}
source("~/GitHub/RISKPLOTS/PlotRiskCategoriesAndTimetoEvent.R")
pander::pander(obsexp)
pander::pander(timesdata)

```


## Second Simulation
```{r}

ContBetaRate_1 <- RContBetaRate_1*3
BinBetaRate_1 <- RBinBetaRate_1*2
BinBetaRate_2 <- RBinBetaRate_2*2
BaselineHazard <- RBaselineHazard*3

source("~/GitHub/RISKPLOTS/simulate_events.R")

```



## RRplots High prevalence

```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}

plotTimeInterval <- timeSpan # Calibrated

hazard <- -log(1.0-simulatedDataFrame$pevent)
hboost <- plotTimeInterval/timeInterval
pvalue <- 1.0-exp(-hboost*hazard)


rdata <- cbind(simulatedDataFrame$status,pvalue)
summary(rdata[,2])
table(simulatedDataFrame$status)

par(cex=0.75)

RRAnalysisCI <- RRPlot(rdata,atRate=c(0.90),
                     timetoEvent=simulatedDataFrame$time,
                     title="Simulation 2",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=plotTimeInterval)

par(op)

```


### By Risk Categories and Mean Time to Event
```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}

source("~/GitHub/RISKPLOTS/PlotRiskCategoriesAndTimetoEvent.R")

pander::pander(obsexp)
pander::pander(timesdata)

```

### Comparing the ROC

```{r}

pander::pander(roc.test(RRAnalysisCI_LP$ROCAnalysis$ROC.analysis$roc.predictor,RRAnalysisCI$ROCAnalysis$ROC.analysis$roc.predictor))


```


## Third Simulation
```{r}

ContBetaRate_1 <- RContBetaRate_1*10
BinBetaRate_1 <- RBinBetaRate_1*5
BinBetaRate_2 <- RBinBetaRate_2*5
BaselineHazard <- RBaselineHazard*5

source("~/GitHub/RISKPLOTS/simulate_events.R")

```



## RRplots Higher prevalence

```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}

plotTimeInterval <- timeSpan # Calibrated

hazard <- -log(1.0-simulatedDataFrame$pevent)
hboost <- plotTimeInterval/timeInterval
pvalue <- 1.0-exp(-hboost*hazard)


rdata <- cbind(simulatedDataFrame$status,pvalue)
summary(rdata[,2])
table(simulatedDataFrame$status)
par(cex=0.75)


RRAnalysisCI <- RRPlot(rdata,atRate=c(0.90),
                     timetoEvent=simulatedDataFrame$time,
                     title="Simulation 3",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=plotTimeInterval)

par(op)

```


### By Risk Categories and Mean Time to Event
```{r results = "asis",warning = FALSE , dpi=600, fig.height= 5.0, fig.width= 7.0}

source("~/GitHub/RISKPLOTS/PlotRiskCategoriesAndTimetoEvent.R")

pander::pander(obsexp)
pander::pander(timesdata)

```

### Comparing the ROC

```{r}

pander::pander(roc.test(RRAnalysisCI_LP$ROCAnalysis$ROC.analysis$roc.predictor,RRAnalysisCI$ROCAnalysis$ROC.analysis$roc.predictor))


```

