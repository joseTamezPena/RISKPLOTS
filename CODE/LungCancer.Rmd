---
title: "Lung Cancer"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    df_print: paged
  pdf_document:
    toc: yes
    fig_caption: yes
    fig_crop: no
    number_sections: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Detailed Survival analyis of the Survival lung data.

### Libraries
```{r}
library(survival)
library(FRESA.CAD)
op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('keep.trailing.zeros',TRUE)


```
### Libraries

```{r results = "asis"}
data(lung)
lung$inst <- NULL
lung$status <- lung$status - 1
lung <- lung[complete.cases(lung),]

pander::pander(table(lung$status))
pander::pander(summary(lung$time))
```


## Exploring Raw Features with RRPlot

```{r results = "asis", warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}
convar <- colnames(lung)[lapply(apply(lung,2,unique),length) > 10]
convar <- convar[convar != "time"]
topvar <- univariate_BinEnsemble(lung[,c("status",convar)],"status")
pander::pander(topvar)
topv <- min(5,length(topvar))
topFive <- names(topvar)[1:topv]
RRanalysis <- list();
idx <- 1
for (topf in topFive)
{
  RRanalysis[[idx]] <- RRPlot(cbind(lung$status,lung[,topf]),
                              atRate=c(0.90),
                  timetoEvent=lung$time,
                  title=topf,
#                  plotRR=FALSE
                  )
  idx <- idx + 1
}
names(RRanalysis) <- topFive
```

## Reporting the Metrics

```{r results = "asis", warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}
ROCAUC <- NULL
CstatCI <- NULL
LogRangp <- NULL
Sensitivity <- NULL
Specificity <- NULL

for (topf in topFive)
{
  CstatCI <- rbind(CstatCI,RRanalysis[[topf]]$c.index$cstatCI)
  LogRangp <- rbind(LogRangp,RRanalysis[[topf]]$surdif$pvalue)
  Sensitivity <- rbind(Sensitivity,RRanalysis[[topf]]$ROCAnalysis$sensitivity)
  Specificity <- rbind(Specificity,RRanalysis[[topf]]$ROCAnalysis$specificity)
  ROCAUC <- rbind(ROCAUC,RRanalysis[[topf]]$ROCAnalysis$aucs)
}
rownames(CstatCI) <- topFive
rownames(LogRangp) <- topFive
rownames(Sensitivity) <- topFive
rownames(Specificity) <- topFive
rownames(ROCAUC) <- topFive

pander::pander(ROCAUC)
pander::pander(CstatCI)
pander::pander(LogRangp)
pander::pander(Sensitivity)
pander::pander(Specificity)

meanMatrix <- cbind(ROCAUC[,1],CstatCI[,1],Sensitivity[,1],Specificity[,1])
colnames(meanMatrix) <- c("ROCAUC","C-Stat","Sen","Spe")
pander::pander(meanMatrix)

```


## Modeling
```{r results = "asis", warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}
ml <- BSWiMS.model(Surv(time,status)~1,data=lung,NumberofRepeats = 10)
sm <- summary(ml)
pander::pander(sm$coefficients)
```

## Cox Model Performance

Here we evaluate the model using the RRPlot() function.

### The evaluation of the raw Cox model with RRPlot()

Here we will use the predicted event probability assuming a baseline hazard for events withing 5 years

```{r results = "asis", warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}

timeinterval <- 2*mean(subset(lung,status==1)$time)

h0 <- sum(lung$status & lung$time <= timeinterval)
h0 <- h0/sum((lung$time > timeinterval) | (lung$status==1))
pander::pander(t(c(h0=h0,timeinterval=timeinterval)),caption="Initial Parameters")

index <- predict(ml,lung)

rdata <- cbind(lung$status,ppoisGzero(index,h0))

rrAnalysisTrain <- RRPlot(rdata,atRate=c(0.90),
                     timetoEvent=lung$time,
                     title="Raw Train: Lung Cancer",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=timeinterval)

```


## Expected time to event

```{r results = "asis",warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}
toinclude <- rdata[,1]==1 
obstiemToEvent <- lung$time
tmin<-min(obstiemToEvent)
sum(toinclude)

timetoEvent <- meanTimeToEvent(rdata[,2],timeinterval)
tmax<-max(c(obstiemToEvent,timetoEvent))
lmfit <- lm(obstiemToEvent[toinclude]~0+timetoEvent[toinclude])
sm <- summary(lmfit)
pander::pander(sm)

plot(timetoEvent,obstiemToEvent,
     col=1+rdata[,1],
     xlab="Expected time",
     ylab="Observed time",
     main="Expected vs. Observed",
     xlim=c(tmin,tmax),
     ylim=c(tmin,tmax),
     log="xy")
lines(x=c(tmin,tmax),y=lmfit$coefficients*c(tmin,tmax),lty=1,col="blue")
txt <- bquote(paste(R^2 == .(round(sm$r.squared,3))))
text(tmin+0.005*(tmax-tmin),tmax,txt,cex=0.7)
text(tmin+0.015*(tmax-tmin),tmax,sprintf("Slope=%4.3f",sm$coefficients[1]),cex=0.7)
legend("bottomright",legend=c("No Event","Event","Linear fit"),
             pch=c(1,1,-1),
             col=c(1,2,"blue"),
             lty=c(-1,-1,1)
             )

MADerror2 <- mean(abs(timetoEvent[toinclude]-obstiemToEvent[toinclude]))
pander::pander(MADerror2)


```



### Uncalibrated Performance Report

```{r results = "asis"}

pander::pander(t(rrAnalysisTrain$keyPoints),caption="Threshold values")
pander::pander(t(rrAnalysisTrain$OERatio$estimate),caption="O/E Ratio")
pander::pander(t(rrAnalysisTrain$OE95ci),caption="O/E Mean")
pander::pander(t(rrAnalysisTrain$OAcum95ci),caption="O/Acum Mean")
pander::pander(rrAnalysisTrain$c.index$cstatCI,caption="C. Index")
pander::pander(t(rrAnalysisTrain$ROCAnalysis$aucs),caption="ROC AUC")
pander::pander((rrAnalysisTrain$ROCAnalysis$sensitivity),caption="Sensitivity")
pander::pander((rrAnalysisTrain$ROCAnalysis$specificity),caption="Specificity")
pander::pander(t(rrAnalysisTrain$thr_atP),caption="Probability Thresholds")
pander::pander(rrAnalysisTrain$surdif,caption="Logrank test")

```


### Cox Calibration

```{r results = "asis", warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}
op <- par(no.readonly = TRUE)


calprob <- CoxRiskCalibration(ml,lung,"status","time")

pander::pander(c(h0=calprob$h0,
                 Gain=calprob$hazardGain,
                 DeltaTime=calprob$timeInterval),
               caption="Cox Calibration Parameters")

```

### The RRplot() of the calibrated model

```{r results = "asis",warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}
h0 <- calprob$h0
timeinterval <- calprob$timeInterval;

rdata <- cbind(lung$status,calprob$prob)


rrAnalysisTrain <- RRPlot(rdata,atRate=c(0.90),
                     timetoEvent=lung$time,
                     title="Train Cal: Lung",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=timeinterval)

```


## Expected time to event

```{r results = "asis",warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}

timetoEvent <- meanTimeToEvent(rdata[,2],timeinterval)
tmax<-max(c(obstiemToEvent,timetoEvent))
lmfit <- lm(obstiemToEvent[toinclude]~0+timetoEvent[toinclude])
sm <- summary(lmfit)
pander::pander(sm)

plot(timetoEvent,obstiemToEvent,
     col=1+rdata[,1],
     xlab="Expected time",
     ylab="Observed time",
     main="Expected vs. Observed",
     xlim=c(tmin,tmax),
     ylim=c(tmin,tmax),
     log="xy")
lines(x=c(tmin,tmax),y=lmfit$coefficients*c(tmin,tmax),lty=1,col="blue")
txt <- bquote(paste(R^2 == .(round(sm$r.squared,3))))
text(tmin+0.005*(tmax-tmin),tmax,txt,cex=0.7)
text(tmin+0.015*(tmax-tmin),tmax,sprintf("Slope=%4.3f",sm$coefficients[1]),cex=0.7)
legend("bottomright",legend=c("No Event","Event","Linear fit"),
             pch=c(1,1,-1),
             col=c(1,2,"blue"),
             lty=c(-1,-1,1)
             )

MADerror2 <-c(MADerror2,mean(abs(timetoEvent-obstiemToEvent)))
pander::pander(MADerror2)

```


### Calibrated Train Performance

```{r results = "asis"}

pander::pander(t(rrAnalysisTrain$keyPoints),caption="Threshold values")
pander::pander(t(rrAnalysisTrain$OERatio$estimate),caption="O/E Ratio")
pander::pander(t(rrAnalysisTrain$OE95ci),caption="O/E Mean")
pander::pander(t(rrAnalysisTrain$OAcum95ci),caption="O/Acum Mean")
pander::pander(rrAnalysisTrain$c.index$cstatCI,caption="C. Index")
pander::pander(t(rrAnalysisTrain$ROCAnalysis$aucs),caption="ROC AUC")
pander::pander((rrAnalysisTrain$ROCAnalysis$sensitivity),caption="Sensitivity")
pander::pander((rrAnalysisTrain$ROCAnalysis$specificity),caption="Specificity")
pander::pander(t(rrAnalysisTrain$thr_atP),caption="Probability Thresholds")
pander::pander(rrAnalysisTrain$surdif,caption="Logrank test")

```



## Cross-Validation 

```{r results = "asis", warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}

rcv <- randomCV(theData=lung,
                theOutcome = Surv(time,status)~1,
                fittingFunction=BSWiMS.model, 
                trainFraction = 0.95,
                repetitions=200,
                classSamplingType = "Pro"
         )


stp <- rcv$survTestPredictions
stp <- stp[!is.na(stp[,4]),]

bbx <- boxplot(unlist(stp[,1])~rownames(stp),plot=FALSE)
times <- bbx$stats[3,]
status <- boxplot(unlist(stp[,2])~rownames(stp),plot=FALSE)$stats[3,]
prob <- ppoisGzero(boxplot(unlist(stp[,4])~rownames(stp),plot=FALSE)$stats[3,],h0)

rdatacv <- cbind(status,prob)
rownames(rdatacv) <- bbx$names
names(times) <- bbx$names

rrAnalysisTest <- RRPlot(rdatacv,atRate=c(0.90),
                     timetoEvent=times,
                     title="Test: Lung Cancer",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=timeinterval)

```

###  Cross-Validation Test Performance

```{r results = "asis"}

pander::pander(t(rrAnalysisTest$keyPoints),caption="Threshold values")
pander::pander(t(rrAnalysisTest$OERatio$estimate),caption="O/E Ratio")
pander::pander(t(rrAnalysisTest$OE95ci),caption="O/E Mean")
pander::pander(t(rrAnalysisTest$OAcum95ci),caption="O/Acum Mean")
pander::pander(rrAnalysisTest$c.index$cstatCI,caption="C. Index")
pander::pander(t(rrAnalysisTest$ROCAnalysis$aucs),caption="ROC AUC")
pander::pander((rrAnalysisTest$ROCAnalysis$sensitivity),caption="Sensitivity")
pander::pander((rrAnalysisTest$ROCAnalysis$specificity),caption="Specificity")
pander::pander(t(rrAnalysisTest$thr_atP),caption="Probability Thresholds")
pander::pander(rrAnalysisTest$surdif,caption="Logrank test")

```


### Calibrating the test results

```{r results = "asis", warning = FALSE , dpi=300, fig.height= 5.0, fig.width= 7.0}
rdatacv <- cbind(status,prob,times)
calprob <- CalibrationProbPoissonRisk(rdatacv)

pander::pander(c(h0=calprob$h0,
                 Gain=calprob$hazardGain,
                 DeltaTime=calprob$timeInterval),
               caption="Cox Calibration Parameters")

timeinterval <- calprob$timeInterval;

rdata <- cbind(status,calprob$prob)


rrAnalysisTest <- RRPlot(rdata,atRate=c(0.90),
                     timetoEvent=times,
                     title="Calibrated Test: Lung",
                     ysurvlim=c(0.00,1.0),
                     riskTimeInterval=timeinterval)

```

### Calibrated Test Performance

```{r results = "asis"}

pander::pander(t(rrAnalysisTest$keyPoints),caption="Threshold values")
pander::pander(t(rrAnalysisTest$OERatio$estimate),caption="O/E Ratio")
pander::pander(t(rrAnalysisTest$OE95ci),caption="O/E Mean")
pander::pander(t(rrAnalysisTest$OAcum95ci),caption="O/Acum Mean")
pander::pander(rrAnalysisTest$c.index$cstatCI,caption="C. Index")
pander::pander(t(rrAnalysisTest$ROCAnalysis$aucs),caption="ROC AUC")
pander::pander((rrAnalysisTest$ROCAnalysis$sensitivity),caption="Sensitivity")
pander::pander((rrAnalysisTest$ROCAnalysis$specificity),caption="Specificity")
pander::pander(t(rrAnalysisTest$thr_atP),caption="Probability Thresholds")
pander::pander(rrAnalysisTest$surdif,caption="Logrank test")

```
